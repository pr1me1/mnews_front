<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Article Detail ‚Äî News Portal</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        * { box-sizing: border-box; margin:0; padding:0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f5f7fa; color:#28303b; line-height:1.6; }
        .container { max-width:900px; margin:0 auto; padding:20px; }
        header { background:#fff; box-shadow:0 2px 10px rgba(0,0,0,0.06); position:sticky; top:0; z-index:1000; }
        header .container { display:flex; gap:20px; align-items:center; justify-content:space-between; padding:14px 20px; flex-wrap:wrap; }
        .logo { font-weight:700; letter-spacing:0.4px; color:#2b3a4a; font-size:20px; }
        nav a { text-decoration:none; color:#2b3a4a; padding:8px 12px; border-radius:6px; font-weight:600; font-size:14px; }
        nav a:hover { background:#eef6ff; color:#1e73d1; }
        .auth-btn { background:#1273d1; color:#fff; padding:8px 14px; border-radius:8px; text-decoration:none; font-weight:600; font-size:14px; border:none; cursor:pointer; }
        .auth-btn.secondary { background:#f1f5f8; color:#2b3a4a; border:1px solid #e6eef6; }
        main { padding:20px 0 60px; min-height:60vh; }
        .article-container { background:#fff; border-radius:12px; padding:32px; box-shadow:0 4px 12px rgba(10,20,30,0.06); margin-bottom:24px; }
        .article-meta { color:#6b7785; font-size:14px; margin-bottom:16px; display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
        .article-title { font-size:36px; font-weight:800; color:#1f2a36; margin-bottom:32px; line-height:1.2; }
        .article-actions { display:flex; gap:12px; align-items:center; margin:32px 0; padding:20px 0; border-top:1px solid #eef3f7; border-bottom:1px solid #eef3f7; }
        .action-btn { background:#f8fafc; border:1px solid #e2e8f0; padding:10px 18px; border-radius:8px; cursor:pointer; font-weight:600; display:flex; align-items:center; gap:8px; font-size:14px; transition: all 0.2s; }
        .action-btn:hover { background:#eef6ff; border-color:#1273d1; color:#1273d1; transform: translateY(-1px); }
        .action-btn.active { background:#1273d1; color:#fff; border-color:#1273d1; }
        .reaction-count { background:#e2e8f0; padding:2px 8px; border-radius:12px; font-size:12px; font-weight:600; }
        .article-content { font-size:17px; color:#2d3748; line-height:1.8; }
        .article-block { margin-bottom:28px; }
        .article-block h1, .article-block h2, .article-block h3, .article-block h4, .article-block h5, .article-block h6 { color:#1a202c; margin:32px 0 16px; line-height:1.3; font-weight:700; }
        .article-block h1 { font-size:32px; }
        .article-block h2 { font-size:28px; }
        .article-block h3 { font-size:24px; }
        .article-block h4 { font-size:20px; }
        .article-block h5 { font-size:18px; }
        .article-block h6 { font-size:16px; }
        .article-block p { margin-bottom:20px; line-height:1.8; }
        .article-block img { max-width:100%; height:auto; border-radius:10px; margin:24px 0; display:block; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
        .article-block figure { margin:32px 0; }
        .article-block figcaption { text-align:center; color:#6b7785; font-size:14px; margin-top:12px; font-style:italic; }
        .article-block video { max-width:100%; border-radius:10px; display:block; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
        .article-block blockquote { border-left:4px; solid:#1273d1; padding:20px 24px; margin:28px 0; background:#f8fafc; border-radius:0 8px 8px 0; font-style:italic; color:#4a5568; font-size:18px; }
        .article-block ul, .article-block ol { margin:20px 0 20px 24px; }
        .article-block li { margin-bottom:10px; line-height:1.7; }
        .article-block hr { border:none; border-top:2px solid #e2e8f0; margin:40px 0; }
        .article-block code { background:#f1f5f9; padding:2px 6px; border-radius:4px; font-family:'Courier New', monospace; font-size:0.9em; color:#e53e3e; }
        .article-block pre { background:#1e293b; color:#e2e8f0; padding:20px; border-radius:8px; overflow-x:auto; margin:20px 0; }
        .article-block pre code { background:none; color:inherit; padding:0; }
        .article-block a { color:#1273d1; text-decoration:none; border-bottom:1px solid transparent; transition:border-color 0.2s; }
        .article-block a:hover { border-bottom-color:#1273d1; }
        .pullquote { text-align:center; font-size:26px; font-weight:700; color:#1273d1; margin:40px 0; padding:32px; background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius:12px; border-left:6px solid #1273d1; }
        .embed-container { margin:32px 0; padding:20px; background:#f8fafc; border-radius:10px; border:1px solid #e2e8f0; }
        .comments-section { background:#fff; border-radius:12px; padding:24px; box-shadow:0 4px 12px rgba(10,20,30,0.06); }
        .comments-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .comments-title { font-size:20px; font-weight:700; color:#1f2a36; }
        .comment-form { margin-bottom:24px; }
        .comment-textarea { width:100%; min-height:100px; padding:12px; border:1px solid #e2e8f0; border-radius:8px; font-family:inherit; font-size:14px; resize:vertical; }
        .comment-textarea:focus { outline:none; border-color:#1273d1; box-shadow:0 0 0 3px rgba(18,115,209,0.1); }
        .comment-actions { display:flex; justify-content:space-between; align-items:center; margin-top:12px; }
        .btn { padding:8px 16px; border-radius:8px; font-weight:600; font-size:14px; cursor:pointer; border:none; transition:all 0.2s; }
        .btn-primary { background:#1273d1; color:#fff; }
        .btn-secondary { background:#f8fafc; color:#4a5568; border:1px solid #e2e8f0; }
        .btn:hover { opacity:0.9; transform:translateY(-1px); }
        .btn:disabled { opacity:0.6; cursor:not-allowed; transform:none; }
        .auth-prompt { text-align:center; padding:20px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; }
        .auth-prompt a { color:#1273d1; text-decoration:none; font-weight:600; }
        .comment { border:1px solid #eef3f7; border-radius:8px; padding:16px; margin-bottom:12px; background:#fafbfc; }
        .comment-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; }
        .comment-author { font-weight:600; color:#1f2a36; }
        .comment-date { color:#6b7785; font-size:13px; }
        .comment-body { color:#4a5568; margin-bottom:12px; }
        .comment-reactions { display:flex; gap:8px; align-items:center; }
        .reaction-btn { background:none; border:none; padding:4px 8px; border-radius:6px; cursor:pointer; font-size:12px; display:flex; align-items:center; gap:4px; transition:all 0.2s; }
        .reaction-btn:hover { background:#f7fafc; }
        .reaction-btn.active { background:#dbeafe; color:#1e40af; }
        .reply-form { margin-top:12px; }
        .replies-container { margin-left:24px; margin-top:12px; }
        .loading { text-align:center; color:#6b7785; padding:20px; }
        .error { color:#e53e3e; background:#fed7d7; padding:12px; border-radius:8px; margin-bottom:16px; }
        .success { color:#38a169; background:#c6f6d5; padding:12px; border-radius:8px; margin-bottom:16px; }
        .back-link { display:inline-flex; align-items:center; gap:8px; color:#6b7785; text-decoration:none; margin-bottom:20px; font-weight:600; }
        .back-link:hover { color:#1273d1; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-menu { display: none; position: absolute; right: 0; top: 100%; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; padding: 8px; min-width: 150px; z-index: 1000; margin-top: 4px; }
        .dropdown-menu.show { display: block; }
        .dropdown-menu a, .dropdown-menu button { display: block; width: 100%; text-align: left; padding: 8px 12px; text-decoration: none; color: #2b3a4a; background: none; border: none; cursor: pointer; border-radius: 4px; font-size: 14px; }
        .dropdown-menu a:hover, .dropdown-menu button:hover { background: #f8fafc; }
        @media (max-width: 768px) {
            .container { padding:12px; }
            .article-container, .comments-section { padding:20px; }
            .article-title { font-size:28px; }
            .article-actions { flex-direction:column; align-items:stretch; }
            .action-btn { justify-content:center; }
        }
    </style>
</head>
<body>
<header>
    <div class="container">
        <div style="display:flex;align-items:center;gap:16px;">
            <div class="logo">NEWS PORTAL</div>
            <nav>
                <a href="main.html">Home</a>
                <a href="main.html">Categories</a>
            </nav>
        </div>
        <div id="headerActions">
            <div class="loading" style="font-size:14px;">Loading...</div>
        </div>
    </div>
</header>

<main>
    <div class="container">
        <a href="main.html" class="back-link">‚Üê Back to Home</a>

        <div id="articleContainer">
            <div class="loading">Loading article...</div>
        </div>

        <div id="commentsSection" style="display:none;">
            <div class="comments-section">
                <div class="comments-header">
                    <h3 class="comments-title">Comments (<span id="commentCount">0</span>)</h3>
                </div>

                <div id="commentForm" style="display:none;">
                    <div class="comment-form">
                        <textarea id="commentText" class="comment-textarea" placeholder="Share your thoughts..."></textarea>
                        <div class="comment-actions">
                            <div></div>
                            <div>
                                <button id="cancelComment" class="btn btn-secondary" style="margin-right:8px;">Cancel</button>
                                <button id="submitComment" class="btn btn-primary">Post Comment</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="authPrompt" style="display:none;">
                    <div class="auth-prompt">
                        <p>Please <a href="login.html">login</a> or <a href="register.html">register</a> to join the discussion.</p>
                    </div>
                </div>

                <div id="commentsContainer">
                    <div class="loading">Loading comments...</div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    (function() {
        let currentUser = null;
        let currentArticle = null;
        let isAuthenticated = false;

        const BASE = "https://mnews.jprq.site";
        const ARTICLE_URL = (slugOrId) => `${BASE}/api/v1/articles/${encodeURIComponent(slugOrId)}/`;
        const PROFILE_URL = `${BASE}/api/v1/users/my-profile/`;
        const LOGOUT_URL = `${BASE}/api/v1/auth/logout/`;
        const COMMENTS_URL = (articleId) => `${BASE}/api/v1/articles/${articleId}/comments/`;
        const COMMENT_CREATE_URL = `${BASE}/api/v1/comments/`;
        const REACTION_TOGGLE_URL = `${BASE}/api/v1/reactions/toggle/`;
        const BOOKMARK_TOGGLE_URL = `${BASE}/api/v1/bookmarks/toggle/`;
        const REACTION_STATS_URL = (targetType, targetId) => `${BASE}/api/v1/reactions/stats/${targetType}/${targetId}/`;

        const headerActions = document.getElementById('headerActions');
        const articleContainer = document.getElementById('articleContainer');
        const commentsSection = document.getElementById('commentsSection');
        const commentForm = document.getElementById('commentForm');
        const authPrompt = document.getElementById('authPrompt');
        const commentsContainer = document.getElementById('commentsContainer');
        const commentCount = document.getElementById('commentCount');
        const commentText = document.getElementById('commentText');
        const submitComment = document.getElementById('submitComment');
        const cancelComment = document.getElementById('cancelComment');

        async function fetchJson(url, options = {}) {
            try {
                const token = localStorage.getItem("accessToken");
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                if (token) {
                    headers['Authorization'] = 'Bearer ' + token;
                }

                const res = await fetch(url, { ...options, headers });

                if (!res.ok) {
                    const errorText = await res.text().catch(() => '');
                    throw new Error(`Server returned ${res.status}: ${errorText || res.statusText}`);
                }

                const contentType = res.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return await res.json();
                }
                return null;
            } catch (err) {
                console.error('fetchJson error:', err);
                throw err;
            }
        }

        function getArticleIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('slug') || params.get('id');
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleString();
        }

        function showError(message, container = articleContainer) {
            container.innerHTML = `<div class="error">${message}</div>`;
        }

        function showSuccess(message, container) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            container.insertBefore(successDiv, container.firstChild);
            setTimeout(() => successDiv.remove(), 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        async function checkAuthStatus() {
            const token = localStorage.getItem("accessToken");
            if (!token) {
                isAuthenticated = false;
                currentUser = null;
                return { isAuthenticated: false, user: null };
            }

            try {
                const res = await fetch(PROFILE_URL, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (res.ok) {
                    const user = await res.json();
                    isAuthenticated = true;
                    currentUser = user;
                    return { isAuthenticated: true, user };
                }
            } catch (err) {
                console.warn('Auth status check failed:', err);
            }

            isAuthenticated = false;
            currentUser = null;
            return { isAuthenticated: false, user: null };
        }

        async function logout() {
            try {
                const refreshToken = localStorage.getItem("refreshToken");
                if (refreshToken) {
                    await fetchJson(LOGOUT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ refresh_token: refreshToken })
                    });
                }
            } catch (err) {
                console.error('Logout error:', err);
            } finally {
                localStorage.clear();
                window.location.reload();
            }
        }

        function renderAuthenticatedHeader(user) {
            const displayName = user.display_name || user.username || user.email || "User";
            headerActions.innerHTML = `
                <div class="dropdown">
                    <button class="auth-btn" onclick="toggleDropdown(this)">${displayName} ‚ñæ</button>
                    <div class="dropdown-menu">
                        <a href="my_profile.html">My Profile</a>
                        <a href="dashboard.html">Dashboard</a>
                        <button onclick="logout()">Logout</button>
                    </div>
                </div>
            `;
        }

        function renderUnauthenticatedHeader() {
            headerActions.innerHTML = `
                <a href="login.html" class="auth-btn">Login</a>
                <a href="register.html" class="auth-btn secondary">Register</a>
            `;
        }

        function toggleDropdown(button) {
            const dropdown = button.nextElementSibling;
            dropdown.classList.toggle('show');

            document.addEventListener('click', function closeDropdown(e) {
                if (!button.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }

        async function loadArticle() {
            const slugOrId = getArticleIdFromUrl();
            if (!slugOrId) {
                showError('Article not found');
                return;
            }

            try {
                const article = await fetchJson(ARTICLE_URL(slugOrId));
                currentArticle = article;
                renderArticle(article);
                commentsSection.style.display = 'block';
                await loadComments(article.id);
            } catch (err) {
                showError(`Failed to load article: ${err.message}`);
            }
        }

        function renderArticle(article) {
            const authorName = article.author ?
                (article.author.display_name || article.author.username || 'Unknown Author') :
                'Unknown Author';

            let contentHtml = '';
            if (article.blocks && article.blocks.length > 0) {
                contentHtml = article.blocks
                    .filter(block => block.visible !== false)
                    .map(block => renderBlock(block))
                    .join('');
            } else {
                contentHtml = '<div class="article-block"><p style="color:#6b7785;font-style:italic;">No content available.</p></div>';
            }

            articleContainer.innerHTML = `
                <div class="article-container">
                    <div class="article-meta">
                        <span>By ${escapeHtml(authorName)}</span>
                        <span>‚Ä¢</span>
                        <span>${formatDate(article.published_at || article.created_at)}</span>
                        ${article.reading_time ? `<span>‚Ä¢ ${article.reading_time} min read</span>` : ''}
                    </div>
                    <h1 class="article-title">${escapeHtml(article.title)}</h1>
                    <div class="article-content">
                        ${contentHtml}
                    </div>
                    <div class="article-actions">
                        <button class="action-btn" onclick="toggleReaction('article', '${article.id}', 'like')">
                            üëç Like <span class="reaction-count" id="likeCount">0</span>
                        </button>
                        <button class="action-btn" onclick="toggleBookmark('article', '${article.id}')">
                            üîñ Bookmark
                        </button>
                        <button class="action-btn" onclick="shareArticle()">
                            üì§ Share
                        </button>
                    </div>
                </div>
            `;

            loadReactionStats('article', article.id);
        }

        function renderBlock(block) {
            switch (block.type) {
                case 'paragraph':
                case 'text':
                    return `<div class="article-block"><p>${escapeHtml(block.content)}</p></div>`;

                case 'heading':
                    const level = Math.min(Math.max(block.meta?.level || 2, 1), 6);
                    return `<div class="article-block"><h${level}>${escapeHtml(block.content)}</h${level}></div>`;

                case 'image':
                    if (block.media?.media_url) {
                        const caption = block.content ?
                            `<figcaption>${escapeHtml(block.content)}</figcaption>` : '';
                        return `<div class="article-block"><figure style="text-align:center;"><img src="${block.media.media_url}" alt="${escapeHtml(block.content || 'Article image')}" style="display:inline-block;" />${caption}</figure></div>`;
                    }
                    return '';

                case 'video':
                    if (block.media?.media_url) {
                        const videoType = block.media.media_url.endsWith('.webm') ? 'video/webm' :
                            block.media.media_url.endsWith('.ogg') ? 'video/ogg' : 'video/mp4';
                        const caption = block.content ?
                            `<p style="text-align:center;color:#6b7785;font-size:14px;margin-top:12px;font-style:italic;">${escapeHtml(block.content)}</p>` : '';
                        return `<div class="article-block" style="text-align:center;"><video controls style="display:inline-block;"><source src="${block.media.media_url}" type="${videoType}">Your browser does not support video.</video>${caption}</div>`;
                    }
                    return '';

                case 'quote':
                case 'blockquote':
                    return `<div class="article-block"><blockquote>${escapeHtml(block.content)}</blockquote></div>`;

                case 'pullquote':
                    return `<div class="article-block"><div class="pullquote">"${escapeHtml(block.content)}"</div></div>`;

                case 'hr':
                case 'divider':
                    return `<div class="article-block"><hr></div>`;

                case 'html':
                    return `<div class="article-block">${block.content}</div>`;

                case 'embed':
                    return `<div class="article-block"><div class="embed-container">${block.content}</div></div>`;

                case 'list':
                    const listTag = block.meta?.ordered ? 'ol' : 'ul';
                    const items = block.content.split('\n').filter(i => i.trim()).map(item =>
                        `<li>${escapeHtml(item.replace(/^[-*]\s*/, ''))}</li>`
                    ).join('');
                    return `<div class="article-block"><${listTag}>${items}</${listTag}></div>`;

                case 'code':
                    const language = block.meta?.language || '';
                    return `<div class="article-block"><pre><code class="language-${language}">${escapeHtml(block.content)}</code></pre></div>`;

                default:
                    return `<div class="article-block"><p>${escapeHtml(block.content)}</p></div>`;
            }
        }

        async function loadReactionStats(targetType, targetId) {
            try {
                const stats = await fetchJson(REACTION_STATS_URL(targetType, targetId));
                const likeCount = document.getElementById('likeCount');
                if (likeCount && stats.reaction_breakdown) {
                    likeCount.textContent = stats.reaction_breakdown.like || 0;
                }
            } catch (err) {
                console.warn('Failed to load reaction stats:', err);
            }
        }

        async function toggleReaction(targetType, targetId, reactionType) {
            if (!isAuthenticated) {
                window.location.href = 'login.html';
                return;
            }

            try {
                await fetchJson(REACTION_TOGGLE_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        target_type: targetType,
                        target_id: targetId,
                        reaction_type: reactionType
                    })
                });
                await loadReactionStats(targetType, targetId);
            } catch (err) {
                console.error('Failed to toggle reaction:', err);
            }
        }

        async function toggleBookmark(targetType, targetId) {
            if (!isAuthenticated) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetchJson(BOOKMARK_TOGGLE_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        target_type: targetType,
                        target_id: targetId
                    })
                });
                showSuccess('Bookmark updated!', articleContainer.querySelector('.article-container'));
            } catch (err) {
                console.error('Failed to toggle bookmark:', err);
            }
        }

        function shareArticle() {
            if (navigator.share && currentArticle) {
                navigator.share({
                    title: currentArticle.title,
                    url: window.location.href
                }).catch(err => copyToClipboard());
            } else {
                copyToClipboard();
            }
        }

        function copyToClipboard() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                showSuccess('Link copied to clipboard!', articleContainer.querySelector('.article-container'));
            }).catch(() => {
                showError('Failed to copy link.');
            });
        }

        async function loadComments(articleId) {
            try {
                const data = await fetchJson(COMMENTS_URL(articleId));
                const comments = data.results || data;
                commentCount.textContent = comments.length;

                if (isAuthenticated) {
                    commentForm.style.display = 'block';
                    authPrompt.style.display = 'none';
                } else {
                    commentForm.style.display = 'none';
                    authPrompt.style.display = 'block';
                }

                renderComments(comments);
            } catch (err) {
                console.error('Failed to load comments:', err);
                showError('Failed to load comments', commentsContainer);
            }
        }

        function renderComments(comments) {
            if (!comments || comments.length === 0) {
                commentsContainer.innerHTML = '<div class="loading">No comments yet. Be the first to share your thoughts!</div>';
                return;
            }

            commentsContainer.innerHTML = comments.map(comment => renderComment(comment)).join('');
        }

        function renderComment(comment) {
            const authorName = comment.user ?
                (comment.user.display_name || comment.user.username || 'Anonymous') :
                'Anonymous';

            const repliesCount = comment.replies_count || 0;
            const hasReplies = repliesCount > 0;

            const repliesSection = hasReplies ? `
        <button class="reaction-btn" id="load-replies-${comment.id}" onclick="loadReplies('${comment.id}')">
            View ${repliesCount} ${repliesCount === 1 ? 'reply' : 'replies'}
        </button>
        <div class="replies-container" id="replies-${comment.id}"></div>
    ` : '<div class="replies-container" id="replies-${comment.id}"></div>';

            return `
        <div class="comment" id="comment-${comment.id}">
            <div class="comment-header">
                <span class="comment-author">${escapeHtml(authorName)}</span>
                <span class="comment-date">${formatDate(comment.created_at)}</span>
            </div>
            <div class="comment-body">${escapeHtml(comment.body)}</div>
            <div class="comment-reactions">
                <button class="reaction-btn" onclick="toggleCommentReaction('${comment.id}', 'like')">
                    üëç <span id="comment-like-${comment.id}">0</span>
                </button>
                ${isAuthenticated ? `<button class="reaction-btn" onclick="replyToComment('${comment.id}')">Reply</button>` : ''}
            </div>
            <div id="reply-form-${comment.id}" style="display:none;">
                <div class="reply-form">
                    <textarea class="comment-textarea" placeholder="Write a reply..." id="reply-text-${comment.id}"></textarea>
                    <div class="comment-actions">
                        <div></div>
                        <div>
                            <button class="btn btn-secondary" onclick="cancelReply('${comment.id}')">Cancel</button>
                            <button class="btn btn-primary" onclick="submitReply('${comment.id}')">Reply</button>
                        </div>
                    </div>
                </div>
            </div>
            ${repliesSection}
        </div>
    `;
        }

        async function loadReplies(commentId) {
            const repliesContainer = document.getElementById(`replies-${commentId}`);
            const loadBtn = document.getElementById(`load-replies-${commentId}`);

            if (!repliesContainer || !loadBtn) return;

            try {
                loadBtn.textContent = 'Loading...';
                loadBtn.disabled = true;

                const replies = await fetchJson(`${BASE}/api/v1/comments/${commentId}/replies/`);
                const repliesData = replies.results || replies;

                if (repliesData && repliesData.length > 0) {
                    repliesContainer.innerHTML = repliesData.map(reply => renderComment(reply)).join('');
                    loadBtn.style.display = 'none';
                } else {
                    repliesContainer.innerHTML = '<div class="loading">No replies yet.</div>';
                    loadBtn.style.display = 'none';
                }
            } catch (err) {
                console.error('Failed to load replies:', err);
                loadBtn.textContent = 'Failed to load replies';
                loadBtn.disabled = false;
            }
        }

        async function submitNewComment() {
            const text = commentText.value.trim();
            if (!text) {
                showError('Please enter a comment.', commentsSection);
                return;
            }

            if (!isAuthenticated) {
                window.location.href = 'login.html';
                return;
            }

            try {
                submitComment.disabled = true;
                submitComment.textContent = 'Posting...';

                await fetchJson(COMMENT_CREATE_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        article: currentArticle.id,
                        body: text
                    })
                });

                commentText.value = '';
                showSuccess('Comment posted successfully!', commentsSection);
                await loadComments(currentArticle.id);
            } catch (err) {
                console.error('Failed to post comment:', err);
                showError(`Failed to post comment: ${err.message}`, commentsSection);
            } finally {
                submitComment.disabled = false;
                submitComment.textContent = 'Post Comment';
            }
        }

        async function toggleCommentReaction(commentId, reactionType) {
            if (!isAuthenticated) {
                window.location.href = 'login.html';
                return;
            }

            try {
                await fetchJson(REACTION_TOGGLE_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        target_type: 'comment',
                        target_id: commentId,
                        reaction_type: reactionType
                    })
                });
            } catch (err) {
                console.error('Failed to toggle comment reaction:', err);
            }
        }

        function replyToComment(commentId) {
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            const isVisible = replyForm.style.display === 'block';
            replyForm.style.display = isVisible ? 'none' : 'block';

            if (!isVisible) {
                const textarea = document.getElementById(`reply-text-${commentId}`);
                textarea.focus();
            }
        }

        function cancelReply(commentId) {
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            const replyText = document.getElementById(`reply-text-${commentId}`);
            replyForm.style.display = 'none';
            replyText.value = '';
        }

        async function submitReply(parentCommentId) {
            const replyText = document.getElementById(`reply-text-${parentCommentId}`);
            const text = replyText.value.trim();

            if (!text) {
                showError('Please enter a reply.', commentsSection);
                return;
            }

            try {
                await fetchJson(COMMENT_CREATE_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        article: currentArticle.id,
                        parent: parentCommentId,
                        body: text
                    })
                });

                replyText.value = '';
                document.getElementById(`reply-form-${parentCommentId}`).style.display = 'none';
                showSuccess('Reply posted successfully!', commentsSection);
                await loadComments(currentArticle.id);
            } catch (err) {
                console.error('Failed to post reply:', err);
                showError(`Failed to post reply: ${err.message}`, commentsSection);
            }
        }

        submitComment.addEventListener('click', submitNewComment);
        cancelComment.addEventListener('click', () => {
            commentText.value = '';
        });

        window.toggleReaction = toggleReaction;
        window.toggleBookmark = toggleBookmark;
        window.shareArticle = shareArticle;
        window.toggleCommentReaction = toggleCommentReaction;
        window.replyToComment = replyToComment;
        window.cancelReply = cancelReply;
        window.submitReply = submitReply;
        window.logout = logout;
        window.toggleDropdown = toggleDropdown;
        window.loadReplies = loadReplies;

        async function initialize() {
            try {
                await checkAuthStatus();

                if (isAuthenticated && currentUser) {
                    renderAuthenticatedHeader(currentUser);
                } else {
                    renderUnauthenticatedHeader();
                }
            } catch (err) {
                console.warn('Auth check failed:', err);
                renderUnauthenticatedHeader();
            }

            const articleId = getArticleIdFromUrl();
            if (!articleId) {
                showError('No article ID or slug provided in URL.');
                return;
            }

            await loadArticle();
        }

        initialize();
    })();
</script>
</body>
</html>