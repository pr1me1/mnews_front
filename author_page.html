<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Author Profile</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        * { box-sizing: border-box; margin:0; padding:0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f5f7fa; color:#28303b; }
        .container { max-width:1100px; margin:0 auto; padding:20px; }
        header { background:#fff; box-shadow:0 2px 10px rgba(0,0,0,0.06); position:sticky; top:0; z-index:1000; }
        header .container { display:flex; gap:20px; align-items:center; justify-content:space-between; padding:14px 20px; flex-wrap:wrap; }
        .logo { font-weight:700; letter-spacing:0.4px; color:#2b3a4a; font-size:20px; }
        nav { display:flex; gap:12px; align-items:center; }
        .nav-menu { display:flex; gap:8px; list-style:none; align-items:center; }
        .nav-menu a { text-decoration:none; color:#2b3a4a; padding:8px 10px; border-radius:6px; font-weight:600; font-size:14px; }
        .nav-menu a:hover { background:#eef6ff; color:#1e73d1; }

        main { padding:20px 0 60px; min-height:60vh; }
        .section { background:#fff; border-radius:10px; padding:18px; box-shadow:0 2px 8px rgba(10,20,30,0.04); margin-bottom:18px; }

        .author-top { display:flex; gap:18px; align-items:center; }
        .author-avatar { width:100px; height:100px; border-radius:50%; background:#1273d1; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:36px; flex-shrink:0; overflow:hidden; }
        .author-avatar img { width:100%; height:100%; object-fit:cover; display:block; }

        .author-meta h1 { font-size:26px; margin-bottom:6px; color:#142533; }
        .author-meta .role { font-size:13px; color:#6b7785; margin-bottom:8px; }
        .author-meta p { color:#47525a; font-size:15px; margin-bottom:8px; max-width:820px; line-height: 1.5; }

        .author-links { display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
        .link-btn { padding:8px 12px; background:#f1f5f8; color:#2b3a4a; border-radius:8px; text-decoration:none; font-weight:600; font-size:13px; transition: all 0.2s ease; }
        .link-btn:hover { background:#e1f0ff; color:#1273d1; }

        .meta-row { margin-top:12px; color:#6b7785; font-size:13px; }

        .stats-row { display: flex; gap: 20px; margin-top: 10px; }
        .stat-item { font-size: 14px; color: #47525a; }
        .stat-number { font-weight: 700; color: #1273d1; }

        .articles-section { margin-top: 20px; }
        .articles-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .articles-list { margin-top:16px; display:grid; gap:12px; }
        .article-card { display:flex; gap:12px; padding:14px; border-radius:8px; border:1px solid #eef3f7; align-items:flex-start; background:#fff; transition: all 0.2s ease; }
        .article-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-color: #d0e1ff; }
        .article-title { font-weight:700; color:#142533; font-size:16px; margin-bottom:6px; line-height: 1.3; }
        .article-title a { text-decoration: none; color: inherit; }
        .article-title a:hover { color: #1273d1; }
        .article-summary { color:#54646f; font-size:14px; line-height: 1.4; }
        .article-meta { font-size: 12px; color: #6b7785; margin-bottom: 4px; }

        .loading { text-align:center; color:#6b7785; padding:12px; }
        .muted { color:#6b7785; font-size:13px; }

        .back-btn { display:inline-block; margin-bottom:12px; padding:8px 12px; background:#f1f5f8; color:#2b3a4a; border-radius:8px; text-decoration:none; font-weight:700; transition: all 0.2s ease; }
        .back-btn:hover { background:#e1f0ff; color:#1273d1; }

        .error-state { text-align: center; padding: 40px; }
        .error-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }

        @media (max-width:720px) {
            .author-top { flex-direction:column; align-items:flex-start; gap:12px; }
            .author-avatar { width:88px; height:88px; font-size:30px; }
            .stats-row { flex-direction: column; gap: 8px; }
            .articles-header { flex-direction: column; align-items: stretch; gap: 10px; }
        }
    </style>
</head>
<body>
<header>
    <div class="container">
        <div style="display:flex;align-items:center;gap:16px;">
            <div class="logo"><a href="main.html" style="text-decoration:none; color:inherit;">NEWS PORTAL</a></div>
            <nav>
                <ul class="nav-menu" style="align-items:center;">
                    <li><a href="main.html">Home</a></li>
                    <li><a href="main.html">Latest</a></li>
                </ul>
            </nav>
        </div>

        <div style="display:flex;gap:8px;">
            <a href="login.html" class="link-btn" style="text-decoration:none;">Login</a>
            <a href="register.html" class="link-btn" style="text-decoration:none;">Register</a>
        </div>
    </div>
</header>

<main>
    <div class="container">
        <a class="back-btn" id="backBtn" href="main.html">‚Üê Back</a>

        <section class="section" id="authorSection">
            <div id="authorLoading" class="loading">Loading author profile...</div>

            <div id="authorContent" style="display:none;">
                <div class="author-top">
                    <div class="author-avatar" id="authorAvatar">A</div>

                    <div class="author-meta">
                        <h1 id="authorName">Author Name</h1>
                        <div class="role" id="authorRole">Author</div>
                        <p id="authorBio">Author bio goes here.</p>

                        <div class="stats-row" id="authorStats">
                            <div class="stat-item">
                                <span class="stat-number" id="articleCount">0</span> articles
                            </div>
                        </div>

                        <div class="author-links" id="authorLinks"></div>

                        <div class="meta-row" id="authorDates"></div>
                    </div>
                </div>

                <div class="articles-section">
                    <div class="articles-header">
                        <h3>Articles by this author</h3>
                        <div id="sortControls" style="display: none;">
                            <select id="sortSelect" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #ddd;">
                                <option value="newest">Newest first</option>
                                <option value="oldest">Oldest first</option>
                            </select>
                        </div>
                    </div>
                    <div id="authorArticles" class="articles-list">
                        <div class="loading">Loading articles...</div>
                    </div>
                </div>
            </div>

            <div id="authorError" style="display:none;" class="error-state">
                <div class="error-icon">üë§</div>
                <div class="muted">Author not found or an error occurred.</div>
                <div style="margin-top: 10px;">
                    <button onclick="location.reload()" style="padding: 8px 16px; background: #1273d1; color: white; border: none; border-radius: 6px; cursor: pointer;">Try Again</button>
                </div>
            </div>
        </section>
    </div>
</main>

<script>
    (function () {
        const BASE = "http://144.91.124.3:4444";

        function getAuthorApiUrl(authorId) {
            return `${BASE}/api/v1/authors/${encodeURIComponent(authorId)}/`;
        }

        function extractAuthorId() {
            const q = new URLSearchParams(window.location.search).get("id");
            if (q) return q;

            const hash = window.location.hash || "";
            const match = hash.match(/#author\/(.+)/) || hash.match(/author\/(.+)/);
            if (match) return match[1];

            const pathParts = window.location.pathname.split("/").filter(Boolean);
            if (pathParts.length && pathParts[pathParts.length - 1].length > 8) {
                return pathParts[pathParts.length - 1];
            }
            return null;
        }

        function safeText(str) {
            return str == null ? "" : String(str);
        }

        function formatDate(dt) {
            if (!dt) return "";
            try {
                const d = new Date(dt);
                return d.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (e) {
                return safeText(dt);
            }
        }

        function formatRelativeDate(dt) {
            if (!dt) return "";
            try {
                const d = new Date(dt);
                const now = new Date();
                const diffTime = now - d;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays === 0) return "Today";
                if (diffDays === 1) return "Yesterday";
                if (diffDays < 7) return `${diffDays} days ago`;
                if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
                if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;
                return `${Math.floor(diffDays / 365)} years ago`;
            } catch (e) {
                return formatDate(dt);
            }
        }

        // Improved avatar handling for your MediaSerializer format
        function getAvatarSrc(avatarField) {
            if (!avatarField) return null;

            // Handle string URLs directly
            if (typeof avatarField === "string") {
                return avatarField.startsWith('http') ? avatarField : `${BASE}${avatarField}`;
            }

            // Handle MediaSerializer object format
            if (typeof avatarField === "object") {
                // Try different possible URL fields
                const urlFields = ['preview_url', 'url', 'file', 'data'];
                for (const field of urlFields) {
                    if (avatarField[field]) {
                        const url = avatarField[field];
                        return url.startsWith('http') ? url : `${BASE}${url}`;
                    }
                }
            }
            return null;
        }

        async function fetchJson(url) {
            try {
                const res = await fetch(url);
                if (!res.ok) {
                    console.error('API Error:', res.status, res.statusText);
                    return { error: res.status };
                }
                const data = await res.json();
                return { data };
            } catch (err) {
                console.error("fetch error", err);
                return { error: err };
            }
        }

        function createArticleElement(article) {
            const card = document.createElement("div");
            card.className = "article-card";

            const left = document.createElement("div");
            left.style.flex = "1";

            // Article meta (date)
            const meta = document.createElement("div");
            meta.className = "article-meta";
            const publishedDate = article.published_at ? formatRelativeDate(article.published_at) : "";
            meta.textContent = publishedDate;

            // Article title with link
            const title = document.createElement("div");
            title.className = "article-title";
            const link = document.createElement("a");
            link.href = `article.html?slug=${article.slug || article.id}`;
            link.textContent = article.title || "Untitled";
            title.appendChild(link);

            // Article summary
            const summary = document.createElement("div");
            summary.className = "article-summary";
            let summaryText = article.summary || "";

            // If no summary, try to extract from blocks
            if (!summaryText && article.blocks && article.blocks.length) {
                summaryText = article.blocks[0].text || "";
            }

            // Limit summary length
            if (summaryText.length > 150) {
                summaryText = summaryText.slice(0, 147) + "...";
            }
            summary.textContent = summaryText;

            left.appendChild(meta);
            left.appendChild(title);
            if (summaryText) left.appendChild(summary);

            card.appendChild(left);
            return card;
        }

        function sortArticles(articles, sortBy) {
            const sorted = [...articles];
            if (sortBy === 'oldest') {
                return sorted.sort((a, b) => new Date(a.published_at || a.created_at) - new Date(b.published_at || b.created_at));
            } else {
                return sorted.sort((a, b) => new Date(b.published_at || b.created_at) - new Date(a.published_at || a.created_at));
            }
        }

        async function loadAuthor(authorId) {
            const authorSection = document.getElementById("authorSection");
            const loading = document.getElementById("authorLoading");
            const content = document.getElementById("authorContent");
            const errorBox = document.getElementById("authorError");

            loading.style.display = "block";
            content.style.display = "none";
            errorBox.style.display = "none";

            if (!authorId) {
                loading.style.display = "none";
                errorBox.style.display = "block";
                return;
            }

            const url = getAuthorApiUrl(authorId);
            const { data, error } = await fetchJson(url);

            loading.style.display = "none";

            if (error || !data) {
                console.warn("Author fetch error", error);
                errorBox.style.display = "block";
                return;
            }

            try {
                const author = data;

                // Extract name with better fallbacks
                const displayName = (author.user && author.user.display_name) ||
                    (author.user && author.user.first_name && author.user.last_name &&
                        `${author.user.first_name} ${author.user.last_name}`) ||
                    (author.user && author.user.username) || "Author";

                document.getElementById("authorName").textContent = displayName;

                // Role/username
                const roleEl = document.getElementById("authorRole");
                if (author.user && author.user.username && displayName !== author.user.username) {
                    roleEl.textContent = `@${author.user.username}`;
                } else {
                    roleEl.textContent = "Author";
                }

                // Bio
                const bioEl = document.getElementById("authorBio");
                if (author.bio) {
                    bioEl.textContent = author.bio;
                    bioEl.style.display = "block";
                } else {
                    bioEl.style.display = "none";
                }

                // Avatar with improved error handling
                const avatarContainer = document.getElementById("authorAvatar");
                avatarContainer.innerHTML = "";
                const avatarSrc = getAvatarSrc(author.avatar_url);

                if (avatarSrc) {
                    const img = document.createElement("img");
                    img.alt = displayName;
                    img.src = avatarSrc;

                    // Better error handling for avatar loading
                    img.addEventListener("error", () => {
                        console.warn('Avatar failed to load:', avatarSrc);
                        avatarContainer.innerHTML = displayName.charAt(0).toUpperCase();
                    });

                    img.addEventListener("load", () => {
                        console.log('Avatar loaded successfully:', avatarSrc);
                    });

                    avatarContainer.appendChild(img);
                } else {
                    avatarContainer.textContent = displayName.charAt(0).toUpperCase();
                }

                // Article count
                const articleCount = Array.isArray(author.articles) ? author.articles.length : 0;
                document.getElementById("articleCount").textContent = articleCount;

                // Links
                const linksContainer = document.getElementById("authorLinks");
                linksContainer.innerHTML = "";

                if (author.website) {
                    const a = document.createElement("a");
                    a.href = author.website.startsWith('http') ? author.website : `https://${author.website}`;
                    a.target = "_blank";
                    a.rel = "noopener noreferrer";
                    a.className = "link-btn";
                    a.textContent = "Website";
                    linksContainer.appendChild(a);
                }

                if (author.social_links && typeof author.social_links === "object") {
                    for (const [platform, url] of Object.entries(author.social_links)) {
                        if (!url) continue;
                        const a = document.createElement("a");
                        a.href = url.startsWith('http') ? url : `https://${url}`;
                        a.target = "_blank";
                        a.rel = "noopener noreferrer";
                        a.className = "link-btn";
                        a.textContent = platform.charAt(0).toUpperCase() + platform.slice(1);
                        linksContainer.appendChild(a);
                    }
                }

                // Dates
                const dates = document.getElementById("authorDates");
                const joined = author.created_at ? formatDate(author.created_at) : "";
                dates.textContent = joined ? `Joined: ${joined}` : "";

                // Articles with sorting
                const articlesArea = document.getElementById("authorArticles");
                const sortControls = document.getElementById("sortControls");
                const sortSelect = document.getElementById("sortSelect");

                let currentArticles = Array.isArray(author.articles) ? author.articles : [];

                function renderArticles(articles) {
                    articlesArea.innerHTML = "";
                    if (articles.length === 0) {
                        articlesArea.innerHTML = '<div class="muted">No published articles yet.</div>';
                        return;
                    }

                    articles.forEach(article => {
                        articlesArea.appendChild(createArticleElement(article));
                    });
                }

                if (currentArticles.length > 1) {
                    sortControls.style.display = "block";
                    sortSelect.addEventListener("change", (e) => {
                        const sortedArticles = sortArticles(currentArticles, e.target.value);
                        renderArticles(sortedArticles);
                    });
                }

                // Initial render
                renderArticles(sortArticles(currentArticles, 'newest'));

                content.style.display = "block";

                // Update page title
                document.title = `${displayName} - Author Profile`;

            } catch (err) {
                console.error("render author error", err);
                errorBox.style.display = "block";
            }
        }

        // On load
        const authorId = extractAuthorId();
        loadAuthor(authorId);

        // Back button functionality
        const backBtn = document.getElementById("backBtn");
        backBtn.addEventListener("click", (e) => {
            if (window.history.length > 1) {
                e.preventDefault();
                window.history.back();
            }
        });
    })();
</script>
</body>
</html>